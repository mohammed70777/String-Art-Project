<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>String Art Effect</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
</head>
<body>
  <div style="text-align: center; margin-top: 20px;">
    <input type="file" id="imageUpload" accept="image/*" />
  </div>
  <div id="canvasContainer" style="text-align: center; margin-top: 20px;"></div>
  <script>
    let img; // متغير لتحميل الصورة
    const numLines = 1000; // عدد الخطوط المرسومة
    const points = []; // نقاط الحدود التي سيستخدمها الرسم
    let canvas;

    function setup() {
      // إنشاء اللوحة وربطها بالعنصر الحاوي
      canvas = createCanvas(800, 800);
      canvas.parent('canvasContainer');

      // إعداد الخلفية مع النص الإرشادي
      background(0); // خلفية سوداء
      textAlign(CENTER, CENTER);
      fill(255);
      textSize(20);
      text("Select an image using the button above", width / 2, height / 2);

      // ربط حدث تحميل الصورة بزر الاختيار
      const imageInput = document.getElementById('imageUpload');
      imageInput.addEventListener('change', handleImageUpload);
    }

    function draw() {
      noLoop(); // إيقاف التكرار بعد الإطار الأول
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imgElement = new Image();
          imgElement.src = e.target.result;
          imgElement.onload = function () {
            // إنشاء صورة مع خاصية willReadFrequently
            const offscreenCanvas = document.createElement('canvas');
            const offscreenContext = offscreenCanvas.getContext('2d', { willReadFrequently: true });

            offscreenCanvas.width = imgElement.width;
            offscreenCanvas.height = imgElement.height;
            offscreenContext.drawImage(imgElement, 0, 0);

            // تحويل الصورة إلى صيغة p5.js
            img = createImage(imgElement.width, imgElement.height);
            img.drawingContext.drawImage(offscreenCanvas, 0, 0);
            img.resize(800, 800);
            img.filter(GRAY); // تحويل الصورة إلى الأبيض والأسود

            generateBorderPoints(); // إنشاء النقاط الحدودية
            drawStringArt(); // رسم التأثير
          };
        };
        reader.readAsDataURL(file);
      }
    }

    function generateBorderPoints() {
      points.length = 0; // إعادة تعيين النقاط
      const steps = 200; // عدد النقاط على الحدود
      for (let i = 0; i < steps; i++) {
        // النقاط العلوية
        points.push({ x: (width / steps) * i, y: 0 });
        // النقاط اليمنى
        points.push({ x: width, y: (height / steps) * i });
        // النقاط السفلية
        points.push({ x: (width / steps) * (steps - i), y: height });
        // النقاط اليسرى
        points.push({ x: 0, y: (height / steps) * (steps - i) });
      }
    }

    function drawStringArt() {
      background(0); // خلفية سوداء
      stroke(255); // لون الخطوط أبيض
      strokeWeight(0.5); // سماكة الخطوط
      noFill();

      let currentPoint = points[0]; // نقطة البداية
      for (let i = 0; i < numLines; i++) {
        let bestPoint;
        let bestValue = 0;

        for (const p of points) {
          const brightnessValue = getBrightnessValue(p.x, p.y);
          if (brightnessValue > bestValue) {
            bestValue = brightnessValue;
            bestPoint = p;
          }
        }

        // رسم خط بين النقطة الحالية وأفضل نقطة
        line(currentPoint.x, currentPoint.y, bestPoint.x, bestPoint.y);

        // تحديث النقطة الحالية
        currentPoint = bestPoint;
      }
    }

    function getBrightnessValue(x, y) {
      // استرجاع السطوع عند نقطة معينة
      const color = img.get(floor(x), floor(y));
      return brightness(color);
    }
  </script>
</body>
</html>
